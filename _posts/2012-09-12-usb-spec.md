---
layout: post
title: "usb spec"
description: ""
category: 
tags: [usb]
---
{% include JB/setup %}
#0
包组成事务，事务组成传输。

#1.事务
##1.基本概念什么的
一个传输由一个或多个事务组成。

一个事务包含下面三个按顺序传输的包，这些包是USB传输中的最小单元：

    1.令牌包(TOKEN):标识了本次事务的类型。
    2.数据包(DATA):本次事务传输的数据。
    3.握手包(HANDSHAKE):数据的接收方向发送方报告这次传输是否成功。

到底是三种包的哪一种。由包的前8位确定。所有包的第一个字节(前8位)，都是一个叫PID((Packet Identifier Field)的字段。但是后面字段根据TOKEN、DATA、HANDSHAKE包的不同而不同。PID的类型见USB手册的Protocol Layer那一章的Packet Identifier Field那一节，下面只简单描述下每种包的类型。

    TOKEN有OUT、IN、SOF、SETUP。
    DATA有DATA0、DATA1、DATA2、MDATA
    HANDSHAKE有ACK、NAK、STALL、NYET
    Special有PRE、ERR、SPLIT、PING

包在格式在Protocal Layer那一单的Packet Formant节。

那个SPLIT什么的这样的特别的先不看吧。以后补

##2.事务类型
根据令牌包的类型有7种事务：

    IN、OUT、SETUP、PING、SOF、SPLIT、PRE

###1.SETUP事务
SETUP包必须用ACK来应答，如果数据不对，忽略数据，并且不返回握手包。

SETUP事务的数据是一个8字节长度的下面的格式。

    bmRequestType 1 指明控制请求的特性
    bRequest	1 指明控制请求号
    wValue	2 控制请求参数
    wIndex	2 控制请求的参数，主要用于传送引值或衾移量
    wLength	2 指明该控制阶段所需要传输的字节数。

这个是在USB Device Framework那章讲的了。

#2.传输
控制传输、批量传输、中断传输、等时传输
##1.控制传输(Control Transfers)
来自USB2.0 Protocol Layer的Transaction Packet Sequences的(Control Transfers)。

*SETUP事务里也有数据的，这点经常与控制传输的数据阶段弄混。

控制传输最小有两个阶段：Setup和Satus。一个控制传输可能会有可选的在Setup与Status之间的Data阶段。

在Setup阶段，一个SETUP事务用来传送信息到控制端点。

过程如下：

1.先发一个SETUP事务，见上面的SETUP事务。

2.如果存在数据阶段，会由一个或多个IN、OUT事务组成。数据阶段要么全部是IN
，要么全部是OUT。

3.如果有数据阶段，且是OUT的话，那么Status是一个IN事务；如果是IN事务的话，Status是一个OUT事。如果没有数据阶段，Status是一个IN事务。
